<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Spark与TDengine连接总结</title><link rel="shortcut icon" href="/images/avatar.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.png"></div><div class="author"><div class="author-name"><a href="/">lzybetter</a></div><div class="about-me">一个沉迷于IT技术的机械工程师</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">归档</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.png"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/lzybetter"></span><a href="https://github.com/lzybetter" target="_blank" title="https://github.com/lzybetter">https://github.com/lzybetter</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Spark与TDengine连接总结</div><div class="date">写于2023年02月23日</div><div class="content"><p>TDengine是一款高性能的时序数据库，最近在研究如何在Spark中读取和写入数据，这里记录一下最近的成果。</p>
<blockquote>
<p>版本信息：</p>
<ol>
<li>Spark版本：2.4.0，yarn集群模式</li>
<li>Python版本：3.7.9</li>
<li>Scala版本：2.11.12</li>
<li>TDengine版本：2.6，商业版</li>
<li>TAOS-JDBC版本：2.0.42</li>
</ol>
</blockquote>
<h2 id="1-官方JDBC使用"><a href="#1-官方JDBC使用" class="headerlink" title="1. 官方JDBC使用"></a>1. 官方JDBC使用</h2><p>TDengine官方提供了JDBC，Spark读取和写入均可以直接使用</p>
<h3 id="1-1-依赖问题"><a href="#1-1-依赖问题" class="headerlink" title="1.1 依赖问题"></a>1.1 依赖问题</h3><ol>
<li>需要引用taos-jdbcdriver，版本上强烈推荐2.0.42，其他版本会有各种问题(针对2.x系列，3.x系列的没用过)；</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">  &lt;groupId&gt;com.taosdata.jdbc&lt;/groupId&gt;  </span><br><span class="line">  &lt;artifactId&gt;taos-jdbcdriver&lt;/artifactId&gt;  </span><br><span class="line">  &lt;version&gt;2.0.42&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>taos-jdbcdriver的依赖与spark集群可能存在冲突(版本不同)，需要手动指定依赖，方法为：<ol>
<li>下载正确的依赖，我用的是guava-30.1.1-jre.jar和failureaccess-1.0.1.jar </li>
<li>将jar上传hadoop；</li>
<li>在提交spark任务的时候，手动制定依赖：</li>
</ol>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--conf spark.driver.extraClassPath=guava-30.1.1-jre.jar:failureaccess-1.0.1.jar \</span><br><span class="line">--conf spark.executor.extraClassPath=guava-30.1.1-jre.jar:failureaccess-1.0.1.jar </span><br><span class="line">--jars hadoop-path-to-jar/guava-30.1.1-jre.jar,hadoop-path-to-jar/failureaccess-1.0.1.jar </span><br></pre></td></tr></table></figure>

<ol start="3">
<li>对于pyspark程序，最好引用taos-jdbcdriver-2.0.42-dist.jar，补足依赖</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--conf spark.driver.extraClassPath=guava-30.1.1-jre.jar:failureaccess-1.0.1.jar:taos-jdbcdriver-2.0.42-dist.jar </span><br><span class="line">--conf spark.executor.extraClassPath=guava-30.1.1-jre.jar:failureaccess-1.0.1.jar:taos-jdbcdriver-2.0.42-dist.jar </span><br><span class="line">--jars hadoop-path-to-jar/guava-30.1.1-jre.jar,hadoop-path-to-jar/failureaccess-1.0.1.jar,hadoop-path-to-jar/taos-jdbcdriver-2.0.42-dist.jar</span><br></pre></td></tr></table></figure>



<h3 id="1-2-读取"><a href="#1-2-读取" class="headerlink" title="1.2 读取"></a>1.2 读取</h3><p>Spark通过TDBC读取TDengine数据和其他数据库并没有什么本质区别，可以通过以下方法来读取：</p>
<ol>
<li>读取整张表</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">info = spark.read\  </span><br><span class="line">    .<span class="built_in">format</span>(<span class="string">&quot;jdbc&quot;</span>)\  </span><br><span class="line">    .option(<span class="string">&quot;driver&quot;</span>, <span class="string">&quot;com.taosdata.jdbc.rs.RestfulDriver&quot;</span>)\  </span><br><span class="line">    .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:TAOS-RS://ip:port/db?user=user&amp;password=password&quot;</span>)\  </span><br><span class="line">    .option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;test.test&quot;</span>)\  </span><br><span class="line">    .load() </span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>读取部分内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">info = spark.read\  </span><br><span class="line">    .<span class="built_in">format</span>(<span class="string">&quot;jdbc&quot;</span>)\  </span><br><span class="line">    .option(<span class="string">&quot;driver&quot;</span>, <span class="string">&quot;com.taosdata.jdbc.rs.RestfulDriver&quot;</span>)\  </span><br><span class="line">    .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:TAOS-RS://ip:port/db?user=user&amp;password=password&quot;</span>)\  </span><br><span class="line">    .option(<span class="string">&quot;query&quot;</span>, <span class="string">&quot;select * from test.test&quot;</span>)\  </span><br><span class="line">    .load() </span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>如果读取的数量较多，可能会遇到timeout错误，可以设置httpSocketTimeout，单位是ms，默认值为5000</p>
</blockquote>
<h3 id="1-3-存储"><a href="#1-3-存储" class="headerlink" title="1.3 存储"></a>1.3 存储</h3><p>可以使用下面的方法向TDengine保存数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toHbaseSave</span><br><span class="line">  .write</span><br><span class="line">  .<span class="built_in">format</span>(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:TAOS-RS://ip:port/db?user=user&amp;password=password&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;driver&quot;</span>, <span class="string">&quot;com.taosdata.jdbc.rs.RestfulDriver&quot;</span>)</span><br><span class="line">  .mode(SaveMode.Append)</span><br><span class="line">  .option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;test.test&quot;</span>)</span><br><span class="line">  .save()</span><br></pre></td></tr></table></figure>



<h2 id="2-使用自定义数据源写入数据"><a href="#2-使用自定义数据源写入数据" class="headerlink" title="2. 使用自定义数据源写入数据"></a>2. 使用自定义数据源写入数据</h2><p>对于spark来说，直接使用官方的jdbc进行连接只能实现向普通表中写入数据，无法利用TDengine超级表的特性，为了能向超级表中写入数据，需要自定义数据源。</p>
<p>由于只需要写入特性，因此下面的内容中只实现了写入的逻辑，没有实现读取的逻辑，使用scala编写。</p>
<ol>
<li><p>继承DataSourceV2和WriteSupport 并重写createWriter方法，创建自定义的数据源；</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TDSourceV2</span> <span class="keyword">extends</span> <span class="title">DataSourceV2</span>  <span class="keyword">with</span> <span class="title">WriteSupport</span> <span class="keyword">with</span> <span class="title">Serializable</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createWriter</span></span>(</span><br><span class="line">                             jobId: <span class="type">String</span>,  </span><br><span class="line">                             structType: <span class="type">StructType</span>,  </span><br><span class="line">                             saveMode: <span class="type">SaveMode</span>,  </span><br><span class="line">                             dataSourceOptions: <span class="type">DataSourceOptions</span>): <span class="type">Optional</span>[<span class="type">DataSourceWriter</span>] = &#123;  </span><br><span class="line">    <span class="type">Optional</span>.of(<span class="keyword">new</span> <span class="type">TDSourceWriter</span>(  </span><br><span class="line">	<span class="comment">// url</span></span><br><span class="line">      dataSourceOptions.get(<span class="string">&quot;url&quot;</span>).get(),</span><br><span class="line">    <span class="comment">// 用户名  </span></span><br><span class="line">      dataSourceOptions.get(<span class="string">&quot;user&quot;</span>).get(),  </span><br><span class="line">	<span class="comment">// 密码</span></span><br><span class="line">      dataSourceOptions.get(<span class="string">&quot;password&quot;</span>).get(),  </span><br><span class="line">	<span class="comment">// 数据库名称</span></span><br><span class="line">      dataSourceOptions.get(<span class="string">&quot;db&quot;</span>).get(),  </span><br><span class="line">	<span class="comment">// 超级表名称</span></span><br><span class="line">      dataSourceOptions.get(<span class="string">&quot;stable&quot;</span>).get()))  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>继承 DataSourceWriter 重写 createWriterFactory 方法并返回自定义的 DataWriterFactory，重写 commit 方法，用来提交整个事务, 重写 abort 方法，用来做事务回滚；</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TDSourceWriter</span>(<span class="params">  </span></span></span><br><span class="line"><span class="params"><span class="class">                      url: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                      user: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                      password: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                      db: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                      stable: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">DataSourceWriter</span> <span class="keyword">with</span> <span class="title">Serializable</span></span>&#123;  </span><br><span class="line">                      </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createWriterFactory</span></span>(): <span class="type">DataWriterFactory</span>[<span class="type">InternalRow</span>] = &#123;  </span><br><span class="line">    <span class="keyword">new</span> <span class="type">TDWriterFactory</span>(url, user, password, db, stable)  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="comment">// 2.6版本的TDengine不支持事务</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">commit</span></span>(writerCommitMessages: <span class="type">Array</span>[<span class="type">WriterCommitMessage</span>]): <span class="type">Unit</span> = <span class="type">Unit</span>  </span><br><span class="line">  <span class="comment">// 2.6版本的TDengine不支持事务</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">abort</span></span>(writerCommitMessages: <span class="type">Array</span>[<span class="type">WriterCommitMessage</span>]): <span class="type">Unit</span> = <span class="type">Unit</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>继承 DataWriterFactory, 重写 createDataWriter方法返回自定义的 DataWriter；</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TDWriterFactory</span>(<span class="params">  </span></span></span><br><span class="line"><span class="params"><span class="class">                       url: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                       user: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                       password: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                       db: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                       stable: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">DataWriterFactory</span>[<span class="type">InternalRow</span>] <span class="keyword">with</span> <span class="title">Serializable</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createDataWriter</span></span>(  </span><br><span class="line">                                 partitionId: <span class="type">Int</span>,  </span><br><span class="line">                                 taskId: <span class="type">Long</span>,  </span><br><span class="line">                                 epochId: <span class="type">Long</span>): <span class="type">DataWriter</span>[<span class="type">InternalRow</span>] = &#123;  </span><br><span class="line">    <span class="keyword">new</span> <span class="type">TDDataWriter</span>(url, user, password, db, stable)  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>继承 DataWriter 重写 write 方法实现具体的写入数据库逻辑，重写 commit 方法用来提交事务，重写 abort 方法用来做事务回滚 ；</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TDDataWriter</span>(<span class="params">  </span></span></span><br><span class="line"><span class="params"><span class="class">                    url: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                    user: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                    password: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                    db: <span class="type">String</span>,  </span></span></span><br><span class="line"><span class="params"><span class="class">                    stable: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">DataWriter</span>[<span class="type">InternalRow</span>] <span class="keyword">with</span> <span class="title">Serializable</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> logger = <span class="type">LoggerFactory</span>.getLogger(<span class="keyword">this</span>.getClass)  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> conn: <span class="type">Connection</span> = <span class="literal">null</span>  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> stmt: <span class="type">Statement</span> = <span class="literal">null</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">write</span></span>(record: <span class="type">InternalRow</span>): <span class="type">Unit</span> = &#123;  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 在这里编写将数据插入数据库的逻辑</span></span><br><span class="line">	</span><br><span class="line">    <span class="type">Class</span>.forName(<span class="string">&quot;com.taosdata.jdbc.rs.RestfulDriver&quot;</span>)  </span><br><span class="line">    <span class="keyword">val</span> jdbcUrl = <span class="string">s&quot;jdbc:TAOS-RS://<span class="subst">$url</span>/<span class="subst">$db</span>?user=<span class="subst">$user</span>&amp;password=<span class="subst">$password</span>&quot;</span>  </span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 可以通过record.getxxx获取对应列的内容</span></span><br><span class="line">	<span class="comment">// 如table_name = record.getString(0) </span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">val</span> variable1 = record.getString(<span class="number">0</span>)  </span><br><span class="line">    <span class="keyword">val</span> variable2 = record.getInt(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> variable3 = record.getFloat(<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">	<span class="comment">// 构建插入数据库的sql语句</span></span><br><span class="line">	<span class="comment">// 请注意，只有原生连接方式才支持参数绑定的插入方式，</span></span><br><span class="line">	<span class="comment">// 由于要在spark集群上跑，这里用的是Rest的连接方式，</span></span><br><span class="line">	<span class="comment">// 所以只能手动构建插入数据库的sql语句，</span></span><br><span class="line">	<span class="comment">// 关于原生连接、Rest连接和参数绑定插入，请见官方文档</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">val</span> sql = <span class="string">&quot;insert to ...&quot;</span></span><br><span class="line">  </span><br><span class="line">    logger.info(sql)  </span><br><span class="line">  </span><br><span class="line">    conn = <span class="type">DriverManager</span>.getConnection(jdbcUrl)  </span><br><span class="line">    stmt = conn.createStatement()  </span><br><span class="line">    stmt.execute(<span class="string">s&quot;use <span class="subst">$db</span>&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span>&#123;  </span><br><span class="line">      stmt.execute(sql)  </span><br><span class="line">      conn.commit()  </span><br><span class="line">    &#125;<span class="keyword">catch</span> &#123;  </span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt; e.printStackTrace()  </span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;  </span><br><span class="line">      conn.close()  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tdengine2.6版本不支持事务，因此此处并无实际需要做的事情</span></span><br><span class="line">  <span class="comment">// 创建WriterCommitMessage类，绝对不能传null，网上有些代码是错误的</span></span><br><span class="line">  <span class="class"><span class="keyword">object</span> <span class="title">WriteSucceeded</span> <span class="keyword">extends</span> <span class="title">WriterCommitMessage</span>  </span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">commit</span></span>(): <span class="type">WriterCommitMessage</span> = <span class="type">WriteSucceeded</span> </span><br><span class="line">   </span><br><span class="line">  <span class="comment">// Tdengine2.6版本不支持事务，因此此处并无实际需要做的事情</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">abort</span></span>(): <span class="type">Unit</span> = <span class="type">Unit</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用，在程序中指定自定义的datasource并传入参数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">toTdSave  </span><br><span class="line">  .write  </span><br><span class="line">  .format(<span class="string">&quot;org.example.TDSourceV2&quot;</span>)  </span><br><span class="line">  .mode(<span class="type">SaveMode</span>.<span class="type">Append</span>)  </span><br><span class="line">  <span class="comment">// url</span></span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, url)  </span><br><span class="line">  <span class="comment">// 数据库名</span></span><br><span class="line">  .option(<span class="string">&quot;db&quot;</span>, db)  </span><br><span class="line">  <span class="comment">// 用户名</span></span><br><span class="line">  .option(<span class="string">&quot;user&quot;</span>, user)  </span><br><span class="line">  <span class="comment">// 超级表名</span></span><br><span class="line">  .option(<span class="string">&quot;stable&quot;</span>, stable)  </span><br><span class="line">  <span class="comment">// 密码</span></span><br><span class="line">  .option(<span class="string">&quot;password&quot;</span>, password)  </span><br><span class="line">  .save()</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>参考文献：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.modb.pro/db/132365">暑期2021项目经验分享：实现Spark对接openGauss</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/penriver/article/details/115672072">Spark DataSource V1 &amp; V2 API 一文理解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jsledd.cn/2019/04/05/datasourcev2/">Spark SQL DataSource V2 学习入门 + 代码模板</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.taosdata.com/2.6/reference/connector/java/">Tdengine v2.6 官方文档</a></li>
</ol>
</div><div class="tags"><a class="tag-link" href="/tags/Spark/" rel="tag">Spark</a><a class="tag-link" href="/tags/TDengine/" rel="tag">TDengine</a></div></section></div><div class="container"><ul class="nav"><li>下一篇：<a href="/2020/09/20/Python%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%E6%80%BB%E7%BB%93/">Python时间格式总结</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" target="_blank">Bear</a><span>.</span></div></footer>
<script src="/script/jquery.min.js"></script>

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script src="/script/index.js"></script>
<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-61220413-1', 'auto');
ga('send', 'pageview');</script>
<script src="/script/post.js"></script>
</body></html>